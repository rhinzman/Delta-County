<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta County GIS App</title>

    <!-- ArcGIS API for JavaScript CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
    <link rel="stylesheet" href="styles.css">

    <!-- ArcGIS API for JavaScript -->
    <script src="https://js.arcgis.com/4.25/"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Delta County GIS Application</h1>
            <p>Interactive map of Delta County, Michigan</p>
        </div>
        <div class="filter-container">
            <label for="township-filter">Filter by Township:</label>
            <select id="township-filter">
                <option value="">All Townships</option>
                <option value="Baldwin">Baldwin</option>
                <option value="Bay De Noc">Bay De Noc</option>
                <option value="Escanaba">Escanaba</option>
                <option value="Garden">Garden</option>
                <option value="Maple Ridge">Maple Ridge</option>
                <option value="Masonville">Masonville</option>
                <option value="Nahma">Nahma</option>
                <option value="Rapid River">Rapid River</option>
                <option value="Wells">Wells</option>
                <option value="Gladstone">Gladstone</option>
                <option value="Ford River">Ford River</option>
                <option value="Bark River">Bark River</option>


            </select>
        </div>
    </header>
    
    <main>
        <div id="map-container">
            <!-- viewDiv is required by the ArcGIS API for JavaScript MapView -->
            <div id="viewDiv"></div>
        </div>
        
        <!-- Field Collection Button -->
        <a href="https://fieldmaps.arcgis.app/?itemID=4276a0e0d3c945bb821df31742b254de&referenceContext=open&portalURL=https%3A%2F%2Fuw-mad.maps.arcgis.com" 
           target="_blank"
           class="field-collection-btn" 
           title="Open Field Collection App">
            ðŸ“± Field Collection
        </a>

        <script>
            require([
                "esri/config",
                "esri/Map",
                "esri/views/MapView",
                "esri/layers/FeatureLayer",
                "esri/renderers/SimpleRenderer",
                "esri/symbols/SimpleFillSymbol",
                "esri/symbols/SimpleLineSymbol",
                "esri/symbols/SimpleMarkerSymbol",
                "esri/layers/support/FeatureFilter"
            ], function(esriConfig, Map, MapView, FeatureLayer, SimpleRenderer, SimpleFillSymbol, SimpleLineSymbol, SimpleMarkerSymbol, FeatureFilter) {
                // set portal
                esriConfig.portalUrl = "https://uw-mad.maps.arcgis.com";

                // create a map with basemap
                const map = new Map({
                    basemap: "streets"
                });

                // Townships layer
                const townshipsLayer = new FeatureLayer({
                    portalItem: {
                        id: "d915eed690bc40b280e02fe937bc2144"
                    },
                    layerId: 7,
                    title: "Townships",
                    renderer: new SimpleRenderer({
                        symbol: new SimpleFillSymbol({
                            color: "#FFDAB9",
                            outline: new SimpleLineSymbol({
                                color: "#FF8C00",
                                width: 2
                            })
                        })
                    })
                });
                map.add(townshipsLayer);

                // Parcels layer
                const parcelsLayer = new FeatureLayer({
                    portalItem: {
                        id: "3ffcda2f2e2647889ffaec5e19ea766d"
                    },
                    layerId: 2,
                    title: "Delta Parcels",
                    renderer: new SimpleRenderer({
                        symbol: new SimpleFillSymbol({
                            color: null,
                            outline: new SimpleLineSymbol({
                                color: "lightgray",
                                width: 1
                            })
                        })
                    })
                });
                map.add(parcelsLayer);

                // Roads layer
                const roadsLayer = new FeatureLayer({
                    portalItem: {
                        id: "68dcda0490334cb1b1537bb5eabe6c24"
                    },
                    layerId: 1,
                    title: "Roads",
                    renderer: new SimpleRenderer({
                        symbol: new SimpleLineSymbol({
                            color: "darkgray",
                            width: 1.5
                        })
                    })
                });
                map.add(roadsLayer);

                // Address Points layer
                const addressPointsLayer = new FeatureLayer({
                    portalItem: {
                        id: "c6d900ca3cec407ca88a073e16883482"
                    },
                    layerId: 0,
                    title: "Address Points",
                    renderer: new SimpleRenderer({
                        symbol: new SimpleMarkerSymbol({
                            style: "circle",
                            color: "lightblue",
                            size: 5
                        })
                    })
                });
                map.add(addressPointsLayer);

                const view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-86.8, 45.9], // approximate center of Delta County
                    zoom: 10
                });

                view.when(() => {
                    console.log('Map loaded with layers');

                    // Query distinct township labels
                    const query = townshipsLayer.createQuery();
                    query.outFields = ["NAME"];
                    query.returnDistinctValues = true;
                    query.returnGeometry = false;

                    townshipsLayer.queryFeatures(query).then(function(results) {
                        const select = document.getElementById("township-filter");
                        results.features.forEach(function(feature) {
                            const label = feature.attributes.NAME;
                            if (label) {
                                const option = document.createElement("option");
                                option.value = label;
                                option.text = label;
                                select.appendChild(option);
                            }
                        });
                    }).catch(function(error) {
                        console.error('Error querying townships:', error);
                    });

                    // Filter function
                    function applyFilter(value) {
                        if (value) {
                            // Query township geometry
                            const query = townshipsLayer.createQuery();
                            query.where = "NAME = '" + value.replace(/'/g, "''") + "'";
                            query.outFields = ["*"];
                            query.returnGeometry = true;

                            townshipsLayer.queryFeatures(query).then(function(results) {
                                if (results.features.length > 0) {
                                    const geometry = results.features[0].geometry;
                                    // Filter townships by attribute
                                    townshipsLayer.definitionExpression = "NAME = '" + value.replace(/'/g, "''") + "'";
                                    // Filter parcels and address points spatially
                                    parcelsLayer.definitionExpression = "";
                                    parcelsLayer.featureFilter = new FeatureFilter({
                                        geometry: geometry,
                                        spatialRelationship: "intersects"
                                    });
                                    addressPointsLayer.definitionExpression = "";
                                    addressPointsLayer.featureFilter = new FeatureFilter({
                                        geometry: geometry,
                                        spatialRelationship: "intersects"
                                    });
                                }
                            }).catch(function(error) {
                                console.error('Error querying township geometry:', error);
                            });
                        } else {
                            // Clear filters
                            townshipsLayer.definitionExpression = "";
                            parcelsLayer.definitionExpression = "";
                            parcelsLayer.featureFilter = null;
                            addressPointsLayer.definitionExpression = "";
                            addressPointsLayer.featureFilter = null;
                        }
                    }

                    // Event listener for filter
                    document.getElementById("township-filter").addEventListener("change", function(event) {
                        applyFilter(event.target.value);
                    });
                }, function(error){
                    console.error('Map failed to load:', error);
                });
            });

            // Ensure the button opens in a new tab if JS is enabled
            const fcBtn = document.querySelector('.field-collection-btn');
            if (fcBtn) fcBtn.addEventListener('click', function(event) {
                event.preventDefault();
                window.open(this.href, '_blank');
            });
        </script>
    </main>
    
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Delta County GIS Application | Data from Delta County, Michigan</p>
        </div>
    </footer>
    
</body>
</html>
